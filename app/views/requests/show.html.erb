<%= render "shared/header" %>
<main>
  <div class="container-fluid max-container">
    <div class="page-heading"> 
      <div class="ph-left pe-3">
        <%=index_title('Requisição - Visualização')%>
      </div>
      
      <div class="ph-right">
        <%= render partial: 'requests/btnactions' %> 
      </div>
    </div>

    <div class="card card-size">
      <div class="card-body card-body-style">

        <% @requests.each do |request| %>
          <div class="row">
            <div class="col-12 mb-3">
              <div class="col-title d-flex align-items-center">              
                <div>
                  <div class="avatar avatar-request">
                    <%= image_tag "emptyuser.png", alt: "empty user" %>
                  </div>                  
                </div>

                <div class="w-100 ms-2">
                  <div class="first-line">
                    <span class="fw-semibold me-1"><%=request.title%></span>

                    <span class="badge rounded-pill bg-style <%=bg_status(request.status)%> me-2"
                      data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Status da Requisição"><%=status_request(request.status)%>
                    </span>                    

                    <% Methods.get_tags(request.id).each do |tag| %>
                      <span class="badge rounded-pill bg-style bg-tag me-2"
                      data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Tag"><%=tag.description%></span>
                    <% end %>

                    <% if request.mark_description.present? %>
                      <span class="badge rounded-pill bg-style bg-mark me-2" 
                        data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Meta"><i class="fa-solid fa-flag me-1"></i>
                        <%=request.mark_description%>
                      </span>
                    <% end %>
                  </div>
                  
                  <div class="second-line second-line-show text-muted">
                    <span>
                      <span>Criação: <%=format_date(request.created_date)%> </span>
                      <span class="me-3">por <strong><%=request.user_created_name%></strong></span>

                      <span class="me-3"><%=request.projects_description%></span>
                      <span class="me-3">Id: <%=request.id.to_s.rjust(4, "0")%></span>

                      <% if request.customers_name.present? && request.requester_name.present? %>
                        <span class="me-3">Solicitante: <%=request.code.to_s.rjust(4, "0")%>-<%=request.customers_name%>/<%=request.requester_name%></span>
                      <% elsif request.customers_name.present? %>
                        <span class="me-3">Solicitante: <%=request.code.to_s.rjust(4, "0")%>-<%=request.customers_name%></span>                    
                      <% elsif request.requester_name.present? %>
                        <span class="me-3">Solicitante: <%=request.requester_name%></span>                                        
                      <% end %>
                    </span>                
                  </div>

                  <div class="second-line text-muted">
                    <span class="me-3">Previsão: <%=request.dues_date.present? ? format_date(request.dues_date) : '--'%></span>
                    <span class="me-3">Responsável: <strong><%=request.user_responsible_name.present? ? request.user_responsible_name : '--'%></strong></span>                  
                  </div>
                </div>

                <div class="col-priority">
                  <% if request.priority %>
                    <span data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Prioridade">
                      <i class="fa-solid fa-star"></i></span>
                  <% end %>
                </div>                

                <div class="col-step">
                  <span class="badge rounded-pill <%=bg_step(request.step)%> me-1" 
                    data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Status da Execução"><%=step(request.step) %>
                  </span>
                </div>
              </div>
            </div>

            <div class="col-12 mt-2 mb-3">
              <div class="field">
                <label class="form-label">Conteúdo da Requisição</label>
                <div class="border-content"><%= request.content %></div>
               </div>            
            </div>

            <% if request.any_attached? %>
              <div class="col-12">
                <label class="form-label">Anexos</label>
                <div class="table-responsive table-attached">
                  <table class='table table-borderless table-hover'>
                    <tbody>
                      <% @request_files.each do |request_file| %>
                        <% request_file.files.each do |file| %>
                          <tr class="tr-attached">
                            <td class="align-middle" id='filename_<%= file.id %>'><%= file.filename %></td>
                            <td class='align-middle'><%= number_to_human_size(file.byte_size) %></td>

                            <td class='align-middle icon-attached text-center'>
                              <% if ActiveStorage.content_types_allowed_inline.include?(file.content_type) %>
                                <%= link_to rails_blob_url(file, disposition: "inline", only_path: true), target: :_blank,
                                  title: "Visualizar Arquivo", id:"id_view_#{file.id}", class:"class_view" do %>
                                  <i class="fa-solid fa-eye"></i>
                                <%end%>
                              <%else%>                                  
                                <span title="Não disponível">
                                  <i class="fa-solid fa-eye unavailable"></i>
                                </span>
                              <%end%>
                            </td>

                            <td class='align-middle icon-attached text-center'>
                              <%= link_to rails_blob_path(file, disposition: "attachment", only_path: true),
                                title: "Download do Arquivo", id:"id_download_#{file.id}", class:"class_download" do %>
                                <i class="fa-solid fa-download"></i>
                              <%end%> 
                            </td>                              
                          </tr>                          
                        <%end%>
                      <%end%>
                    </tbody>
                  </table>
                </div>
              </div>
            <%end%>

            <%= hidden_field_tag :tag_ids_selected_show, @request_tag_ids.to_a %>
          </div>

          <div class="actions pt-3 text-end">
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <%= render partial: 'requests/modals/delete' %>
  <%= render partial: 'requests/modals/status' %>
  <%= render partial: 'requests/modals/step' %>

</main>